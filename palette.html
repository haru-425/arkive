<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ | Arkive</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #2c3e50, #4ca1af);
      color: white;
      text-align: center;
      padding: 50px;
    }
    .card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 30px;
      margin: 20px auto;
      max-width: 600px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    input, button {
      margin: 10px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
    }
    input[type="color"] {
      width: 60px;
      height: 40px;
      padding: 0;
      border: none;
    }
    button {
      background-color: #fff;
      color: #2c3e50;
      cursor: pointer;
    }
    button:hover {
      background-color: #f0f0f0;
    }
    .palette {
      margin: 10px 0;
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .color-box {
      display: inline-block;
      width: 30px;
      height: 30px;
      margin: 2px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ¨ ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ</h1>
    <p id="status">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</p>

    <div id="palette-form" style="display: none;">
      <input type="text" id="palette-name" placeholder="ãƒ‘ãƒ¬ãƒƒãƒˆåï¼ˆå¿…é ˆï¼‰" /><br />
      <input type="text" id="palette-tags" list="tag-suggestions" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãƒ»å¿…é ˆï¼‰" />
      <datalist id="tag-suggestions"></datalist><br />
      <div id="color-container">
        <input type="color" value="#ff0000" />
        <input type="color" value="#00ff00" />
        <input type="color" value="#0000ff" />
      </div>
      <button onclick="addColor()">ï¼‹è‰²ã‚’è¿½åŠ </button>
      <button onclick="removeColor()">âˆ’è‰²ã‚’å‰Šé™¤</button><br />
      <button onclick="savePalette()">ç™»éŒ²ã™ã‚‹</button>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ§‘â€ğŸ¨ ã‚ãªãŸã®ãƒ‘ãƒ¬ãƒƒãƒˆ</h2>
    <div id="my-palettes">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <div class="card">
    <h2>ğŸŒ ã¿ã‚“ãªã®ãƒ‘ãƒ¬ãƒƒãƒˆ</h2>
    <div id="other-palettes">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA_TQT0dB04nbVhGsVVvQsxlIkQuy2hJIQ",
      authDomain: "arkive-505f0.firebaseapp.com",
      projectId: "arkive-505f0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;

    auth.onAuthStateChanged(user => {
      currentUser = user;
      if (user) {
        document.getElementById("status").textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email}`;
        document.getElementById("palette-form").style.display = "block";
        loadTagSuggestions();
      } else {
        document.getElementById("status").textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚ç™»éŒ²ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚";
        document.getElementById("palette-form").style.display = "none";
      }
      loadPalettes();
    });

    function addColor() {
      const container = document.getElementById("color-container");
      const input = document.createElement("input");
      input.type = "color";
      input.value = "#ffffff";
      container.appendChild(input);
    }

    function removeColor() {
      const container = document.getElementById("color-container");
      if (container.children.length > 1) {
        container.removeChild(container.lastChild);
      }
    }

    function savePalette() {
      const name = document.getElementById("palette-name").value.trim();
      const tagsRaw = document.getElementById("palette-tags").value.trim();
      const colorInputs = document.querySelectorAll("#color-container input[type='color']");
      const colors = Array.from(colorInputs).map(input => input.value);

      if (!name) {
        alert("ãƒ‘ãƒ¬ãƒƒãƒˆåã¯å¿…é ˆã§ã™");
        return;
      }

      if (!tagsRaw) {
        alert("ã‚¿ã‚°ã¯å¿…é ˆã§ã™ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰");
        return;
      }

      const tags = tagsRaw.split(",").map(tag => tag.trim()).filter(tag => tag);

      db.collection("public_palettes").add({
        uid: currentUser.uid,
        name: name,
        tags: tags,
        colors: colors,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert("ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼");
        document.getElementById("palette-name").value = "";
        document.getElementById("palette-tags").value = "";
        loadPalettes();
      }).catch(error => {
        alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
      });
    }

    function loadTagSuggestions() {
      const tagSet = new Set();
      db.collection("public_palettes").get().then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          if (Array.isArray(data.tags)) {
            data.tags.forEach(tag => tagSet.add(tag.trim()));
          }
        });
        const datalist = document.getElementById("tag-suggestions");
        datalist.innerHTML = "";
        Array.from(tagSet).sort().forEach(tag => {
          const option = document.createElement("option");
          option.value = tag;
          datalist.appendChild(option);
        });
      });
    }

    function loadPalettes() {
      db.collection("public_palettes").orderBy("createdAt", "desc").get().then(snapshot => {
        const myList = [];
        const otherList = [];

        snapshot.forEach(doc => {
          const data = doc.data();
          const id = doc.id;
          const html = renderPalette(data.name, data.colors, data.tags, data.uid === currentUser?.uid ? id : null);

          if (currentUser && data.uid === currentUser.uid) {
            myList.push(html);
            otherList.push(html);
          } else {
            otherList.push(html);
          }
        });

        document.getElementById("my-palettes").innerHTML = myList.length ? myList.join("") : "ï¼ˆã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰";
        document.getElementById("other-palettes").innerHTML = otherList.length ? otherList.join("") : "ï¼ˆã¾ã å…¬é–‹ãƒ‘ãƒ¬ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ï¼‰";
      });
    }

    function renderPalette(name, colors, tags, deletableId) {
      let html = `<div class="palette"><strong>${name}</strong><br>`;
      colors.forEach(color => {
        html += `<span class="color-box" style="background:${color};"></span>`;
      });
      html += `<br><small>ã‚¿ã‚°: ${tags.join(", ")}</small>`;
      if (deletableId) {
            html += `<br><button onclick="deletePalette('${deletableId}')">ğŸ—‘ï¸ å‰Šé™¤</button>`;
    }
    html += `</div>`;
    return html;
  }

  function deletePalette(paletteId) {
    if (confirm("ã“ã®ãƒ‘ãƒ¬ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      db.collection("public_palettes").doc(paletteId).delete()
        .then(() => {
          alert("å‰Šé™¤ã—ã¾ã—ãŸ");
          loadPalettes();
        })
        .catch(error => {
          alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        });
    }
  }
</script>
</body>
</html>